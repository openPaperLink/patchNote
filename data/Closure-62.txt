The bug is caused by an incorrect boundary condition in the if-statement that checks the position of `charno` in relation to the `sourceExcerpt` string. Specifically, it does not account for cases where `charno` is equal to `sourceExcerpt.length()`, leading to the subsequent code block being bypassed. This results in incomplete or incorrectly formatted error messages when an error occurs at the end of a line. The failing unit tests, such as `testFormatErrorSpaceEndOfLine1` and `testFormatErrorSpaceEndOfLine2`, demonstrate incorrect caret positioning in error messages, serving as evidence of the bug. The fix involves updating the boundary condition to `0 <= charno && charno <= sourceExcerpt.length()`, ensuring the loop processes even when `charno` equals the string length, thereby handling whitespace correctly and formatting error messages accurately.